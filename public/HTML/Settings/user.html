<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

    <link rel="shortcut icon" href="../../ASSETS/logo/favicon-ri.ico" type="image/x-icon">
    
    <!-- Style -->
    <link rel="stylesheet" href="../../CSS/root.css">
    <link rel="stylesheet" href="../../CSS/nav.css">
    <link rel="stylesheet" href="../../CSS/main.css">
    <link rel="stylesheet" href="../../CSS/load.css">
    <link rel="stylesheet" href="../../CSS/user.css">

    <!--Font Family-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">

    <style>       
        #currentPlan{
            font-size: 1.3rem;
            color: var(--white);
        }
        #save-button{
            color: var(--nav-text);
            font-size: 1.2em;
            font-weight: bold;
            padding: 1rem;
            background-color: transparent;
            border: 2px solid var(--secondary);
            cursor: pointer;
            transition: .3s ease;
        }
        #save-button:hover{
            transform: scale(.9);
            border: 2px dashed var(--secondary);
        }
    </style>
</head>
<body>

    <header>
        <a href="../../index.html"><img src="../../ASSETS/logo/image_2023-11-21_145906080-removebg-preview.png" alt="Logo" id="logo" draggable="false"></a>
        <!-- Nav bar Menu -->
        <nav>
            <!-- Menu Section -->
            <h3>Menu</h3>
            <ul>
                <li><a href="../../index.html"><img src="../../ASSETS/nav-icons/home.png" alt="Home" width="18rem">Home</a></li>
                <li><a href="../Menu/movies.html"><img src="../../ASSETS/nav-icons/movies.png" alt="Movies" width="18rem">Movies</a></li>
                <li><a href="../Menu/series.html    "><img src="../../ASSETS/nav-icons/series.png" alt="Series" width="18rem">Series</a></li>
                <li><a href="latest.html"><img src="../../ASSETS/nav-icons/recent.png" alt="Home" width="18rem">Latest releases</a></li>
                <!--<li><a href="HTML/Menu/list.html"><img src="ASSETS/nav-icons/list.png" alt="My list" width="18rem">My list</a></li>-->
            </ul>
            <!-- Settings Section  -->
            <h3>Settings</h3>
            <ul>
                <li><a href="../Settings/sub.html"><img src="../../ASSETS/nav-icons/subscription.png" alt="Subscription" width="18rem">Subscription</a></li>
                <li><a href="../Settings/faq.html"><img src="../../ASSETS/nav-icons/faq.png" alt="FAQ" width="18rem">FAQ</a></li>
                <li><a href="../Settings/terms.html"><img src="../../ASSETS/nav-icons/terms.png" alt="Terms" width="18rem">Terms of Use</a></li>
                <li><a href="../Settings/privacy.html"><img src="../../ASSETS/nav-icons/privacy.png" alt="Privacy" width="18rem">Privacy</a></li>
                <li><a href="../Settings/contact.html"><img src="../../ASSETS/nav-icons/contact.png" alt="Contact us" width="18rem">Contact us</a></li>
                <li><a href="user.html"><img src="../../ASSETS/nav-icons/user.png" alt="Account" width="18rem">Account</a></li>
            </ul>
        </nav>
        <li id="ceos">
            <a href="../ceo.html" ><img src="../../ASSETS/nav-icons/CEOS.png" alt="Home" width="18rem">CEOS</a>
        </li>

        <input type="checkbox" id="menu-phone-button">
        <div id="phone-menu">
            <nav>
                <!-- Menu Section -->
                <h3>Menu</h3>
                <ul>
                    <li><a href="../../index.html"><img src="../../ASSETS/nav-icons/home.png" alt="Home" width="18rem">Home</a></li>
                    <li><a href="movies.html"><img src="../../ASSETS/nav-icons/movies.png" alt="Movies" width="18rem">Movies</a></li>
                    <li><a href="series.html"><img src="../../ASSETS/nav-icons/series.png" alt="Series" width="18rem">Series</a></li>
                    <li><a href="#"><img src="../../ASSETS/nav-icons/recent.png" alt="Latest releases" width="18rem">Latest releases</a></li>
                    <!--<li><a href="HTML/Menu/list.html"><img src="ASSETS/nav-icons/list.png" alt="My list" width="18rem">My list</a></li>-->
                </ul>
                <!-- Settings Section -->
                <h3>Settings</h3>
                <ul>
                    <li><a href="../Settings/sub.html"><img src="../../ASSETS/nav-icons/subscription.png" alt="Subscription" width="18rem">Subscription</a></li>
                    <li><a href="../Settings/faq.html"><img src="../../ASSETS/nav-icons/faq.png" alt="FAQ" width="18rem">FAQ</a></li>
                    <li><a href="../Settings/terms.html"><img src="../../ASSETS/nav-icons/terms.png" alt="Terms of Use" width="18rem">Terms of Use</a></li>
                    <li><a href="../Settings/privacy.html"><img src="../../ASSETS/nav-icons/privacy.png" alt="Privacy" width="18rem">Privacy</a></li>
                    <li><a href="../Settings/contact.html"><img src="../../ASSETS/nav-icons/contact.png" alt="Contact us" width="18rem">Contact us</a></li>
                    <li><a href="user.html"><img src="../../ASSETS/nav-icons/user.png" alt="Account" width="18rem">Account</a></li>
                </ul>
            </nav>
            <li id="ceos">
                <a href="../ceo.html" ><img src="../../ASSETS/nav-icons/CEOS.png" alt="CEOS" width="18rem">CEOS</a>
            </li>
        </div>
    </header>
    <main>
        <section>
            <div id="page-top">
                <h1 class="mainTit">A<span class="spanMovie">c</span>count</h1>
            </div>

            <div id="user-info">
                <img src="../../ASSETS/user/profile.png" alt="" id="user-photo" style="cursor: pointer;">
                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                <button id="save-button" style="display: none;">Save</button>

                <div id="info-1">
                    <div id="user-email-container">
                        <h1 id="user-nick">Username: </h1>
                        <p id="user-email">"email@gmail.com"</p>
                    </div>
                    <button id="logout-button">Logout</button>
                </div>
            </div>
            <span id="line"></span>
            <div id="subscription-plan">
                <h2>Subscription Plan</h2>
                <p id="currentPlan">Current Plan: </p>
                <div><button id="change-plan"><a href="sub.html">Change Plan</a></button></div>
            </div>
        </section>
    </main>

    <!-- Script -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBH42VD0gk48KLx74gWNU9u-Kz9z751q8A",
            authDomain: "tvbe-24768.firebaseapp.com",
            projectId: "tvbe-24768",
            storageBucket: "tvbe-24768.appspot.com",
            messagingSenderId: "459135185545",
            appId: "1:459135185545:web:30a8f0aa37f56902824c58",
            measurementId: "G-MK82D5BEGM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        document.getElementById('user-photo').addEventListener('click', () => {
            document.getElementById('profile-picture-input').click();
        });

        document.getElementById('profile-picture-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected.');
                return;
            }

            document.getElementById('save-button').style.display = 'inline';

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('user-photo').src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('save-button').addEventListener('click', () => {
            const fileInput = document.getElementById('profile-picture-input');
            const file = fileInput.files[0];
            if (!file) {
                console.log('No file ready to upload.');
                return;
            }

            const storageRef = ref(storage, 'profile-pictures/' + auth.currentUser.uid);

            uploadBytes(storageRef, file).then((snapshot) => {
                console.log('Uploaded a blob or file!');
                return getDownloadURL(snapshot.ref);
            }).then((downloadURL) => {
                console.log('File available at', downloadURL);
                document.getElementById('user-photo').src = downloadURL; 
                const userRef = doc(db, 'users', auth.currentUser.uid);
                return updateDoc(userRef, {
                    profilePicture: downloadURL
                });
            }).then(() => {
                console.log('Profile picture updated in Firestore.');
                window.location.reload(); 
            }).catch((error) => {
                console.error('Error uploading image and updating profile:', error);
            });
        });


        onAuthStateChanged(auth, (user) => {
            if (user) {
            const userRef = doc(db, "users", user.uid);
            getDoc(userRef).then((docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    document.getElementById('user-nick').textContent += userData.username;
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('currentPlan').textContent += userData.subscription;
                    if (userData.profilePicture) {
                        document.getElementById('user-photo').src = userData.profilePicture;
                    } else {
                        console.log("No such document!");
                    }
                }
                }).catch((error) => {
                    console.log("Error getting document:", error);
                });
            } else {
                window.location.href = 'https://tvbe-24768.web.app/login.html';
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log("User signed out successfully");
                window.location.href = 'https://tvbe-24768.web.app/login.html';
            }).catch((error) => {
                console.error("Error signing out: ", error);
            });
        });

    </script>
    <script src="../../JS/nav.js"></script>
    <script src="../../JS/main.js"></script>
</body>
</html>